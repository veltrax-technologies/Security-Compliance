<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Veltrax — Security & Compliance Map</title>
<style>
  :root{ --bg:#0d1117; --surface:#0f1421; --panel:#121a2a; --text:#e6ecf3; --muted:#9aa7b6; --border:#223047; --accent:#6f42c1; --accent2:#7aa3ff; --good:#2ecc71; --warn:#ffb454; --opt:#7aa3ff }
  .light:root{ --bg:#f7f9fc; --surface:#ffffff; --panel:#ffffff; --text:#1b2430; --muted:#5a6b83; --border:#d9e2ef; --accent:#6f42c1; --accent2:#4a7dff; --good:#1fa971; --warn:#e39b2e; --opt:#4a7dff }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.6 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:20;background:linear-gradient(to bottom,rgba(2,6,23,.7),rgba(2,6,23,.2)),var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;padding:12px 16px}
  .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent2))}
  .title{font-weight:700}
  .spacer{flex:1}
  .toggle, .btn{border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,0));padding:8px 12px;border-radius:10px;color:var(--text);cursor:pointer}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr 1.2fr;gap:14px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  h2{margin:0 0 8px 0;font-size:18px}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{border:1px solid var(--border);border-radius:12px;padding:10px;background:var(--surface);cursor:pointer}
  .item[aria-current="true"]{outline:2px solid var(--accent)}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700;margin-left:8px}
  .req{background:rgba(46,204,113,.15);color:var(--good);border:1px solid rgba(46,204,113,.35)}
  .rec{background:rgba(255,180,84,.15);color:var(--warn);border:1px solid rgba(255,180,84,.35)}
  .opt{background:rgba(122,163,255,.15);color:var(--opt);border:1px solid rgba(122,163,255,.35)}
  pre{background:#0c1220;border:1px solid #1f2b44;border-radius:10px;padding:10px;overflow:auto;color:#dfe8ff}
  code{font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
  .mini{font-size:12px}
  .teaser{margin:16px 0;border:1px dashed var(--border);border-radius:12px;padding:12px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;background:rgba(255,255,255,.02)}
  .founders{margin:14px 0;border:2px solid var(--accent);background:linear-gradient(180deg,rgba(111,66,193,.10),rgba(111,66,193,.02));border-radius:14px;padding:14px}
  footer{color:var(--muted);border-top:1px solid var(--border);padding:14px;margin-top:16px}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="logo" aria-hidden="true"></div>
  <div class="title">Veltrax — Security & Compliance Map</div>
  <div class="spacer"></div>
  <label class="mini" for="profile">Profile:</label>
  <select id="profile" aria-label="Compliance profile">
    <option value="soc2">SOC‑2</option>
    <option value="hipaa">HIPAA</option>
    <option value="gdpr">GDPR</option>
  </select>
  <button id="theme" class="toggle" aria-label="Toggle theme" style="margin-left:8px">Toggle theme</button>
</header>

<main class="wrap">
  <section class="grid" aria-label="3 columns">
    <!-- Threats -->
    <div class="card" aria-label="Threats column">
      <h2>Threats</h2>
      <div id="threatList" class="list" role="listbox" aria-label="Threat list"></div>
    </div>

    <!-- Controls -->
    <div class="card" aria-label="Controls column">
      <h2>Controls</h2>
      <div id="controlList" class="list" role="listbox" aria-label="Control list"></div>
    </div>

    <!-- Evidence -->
    <div class="card" aria-label="Evidence column">
      <h2>Evidence</h2>
      <div id="evidenceCard" class="item" tabindex="0">
        <div class="muted">Select a control to view evidence.</div>
      </div>
    </div>
  </section>

  <div class="founders" role="note" aria-label="Founders deal">
    <strong>Founders deal:</strong> 30% upfront with milestone deliveries. First 5 get <strong>15% off</strong> + <strong>1 year support</strong>.
  </div>

  <div class="teaser" role="region" aria-label="Next step">
    <div><strong>Next:</strong> Local AI for Strategic Decision‑Making — safe LLMs for high‑stakes business ops.</div>
    <a class="btn" href="PASTE_NEXT_URL_HERE">Open Local AI Strategy</a>
  </div>

  <footer>
    <small>Internal audits run quarterly. All actions are written to immutable, hash‑chained logs with export to CSV/PDF for auditors.</small>
  </footer>
</main>

<script>
// ========= Inline JSON model ========= //
const MODEL = {
  profiles: {
    soc2: {
      badges: { required:['AuthN/Z','Change mgmt','Logging','Encryption'], recommended:['RAG guardrails','Data minimization'], optional:['Quorum updates'] }
    },
    hipaa: {
      badges: { required:['AuthN/Z','Audit logging','Encryption'], recommended:['PII redaction','Data minimization'], optional:['Quorum updates'] }
    },
    gdpr: {
      badges: { required:['Data minimization','Right-to-erasure','Consent'], recommended:['PII redaction','Logging'], optional:['Quorum updates'] }
    }
  },
  threats: [
    { id:'data_exfil', name:'Data exfiltration', map:['rbac','encrypt_rest','dmz_verify','logging'] },
    { id:'model_abuse', name:'Model abuse / jailbreak', map:['prompt_block','rag_guard','rate_limit','logging'] },
    { id:'tampered_release', name:'Tampered update / release', map:['signed_release','quorum','dmz_verify','logging'] },
    { id:'pii_leak', name:'PII exposure', map:['pii_redact','data_min','rbac','logging'] },
    { id:'privilege_escalation', name:'Privilege escalation', map:['rbac','audit_trail','rate_limit','logging'] }
  ],
  controls: {
    rbac: { name:'Role-Based Access Control', evidence:'fastapi_rbac' },
    encrypt_rest: { name:'Encryption at Rest', evidence:'policy_encrypt' },
    dmz_verify: { name:'DMZ Verify & Stage', evidence:'dmz_verify' },
    logging: { name:'Immutable Logging', evidence:'log_policy' },
    prompt_block: { name:'Prompt Blocklist', evidence:'prompt_block' },
    rag_guard: { name:'RAG Guardrails', evidence:'rag_guard' },
    rate_limit: { name:'Rate Limiting', evidence:'rate_limit' },
    signed_release: { name:'Signed Release Manifest', evidence:'release_manifest' },
    quorum: { name:'Quorum for Critical Updates', evidence:'quorum_policy' },
    pii_redact: { name:'PII Redaction', evidence:'pii_redact' },
    data_min: { name:'Data Minimization', evidence:'data_min' },
    audit_trail: { name:'Audit Trail Review', evidence:'audit_review' }
  },
  evidence: {
    jwks_rsa: {
      title:'JWKS RSA (snippet)',
      code:`{\n  "keys": [{\n    "kty": "RSA",\n    "kid": "veltrax-core-1",\n    "use": "sig",\n    "alg": "RS256",\n    "n": "<modulus>",\n    "e": "AQAB"\n  }]\n}`
    },
    fastapi_rbac: {
      title:'FastAPI RBAC decorator',
      code:`from fastapi import Depends, HTTPException\nfrom .auth import current_user\n\nROLE_PERMS = {\n  'analyst': {'read'},\n  'auditor': {'read','export'},\n  'admin': {'read','export','write'}\n}\n\ndef require(*perms):\n  def wrapper(user=Depends(current_user)):\n    allowed = set()\n    for r in user.roles:\n      allowed |= ROLE_PERMS.get(r, set())\n    if not set(perms) <= allowed:\n      raise HTTPException(status_code=403)\n  return wrapper\n\n@app.get('/roi/export')\n@require('export')\nasync def export_roi(...): ...`
    },
    release_manifest: {
      title:'Release Manifest (signatures)',
      code:`manifest:\n  version: 24.10.3\n  artifacts:\n    - core-24.10.3.tgz\n    - finex-24.10.3.tgz\n  signatures:\n    - signer: build@veltrax\n      alg: ed25519\n      sig: <base64>\n    - signer: security@veltrax\n      alg: ed25519\n      sig: <base64>`
    },
    data_min: {
      title:'Data Minimization Policy (excerpt)',
      code:`collection:\n  purpose: [fraud_detection, kyc]\n  retention_days: 365\n  required_fields: [txn_id, amount, timestamp]\n  prohibited_fields: [raw_ssn, raw_ccn]\n  review: quarterly`
    },
    dmz_verify: {
      title:'DMZ Agent Verify (pseudocode)',
      code:`def handle_bundle(path):\n  m = load_manifest(path)\n  for art in m.artifacts:\n    verify_signature(art, m.signatures)\n    scan(art)\n  stage_to_core(m)\n  write_audit_event('bundle.applied', m.version)`
    },
    policy_encrypt: {
      title:'Encryption Policy (excerpt)',
      code:`storage:\n  at_rest: enabled\n  key_rotation_days: 90\n  scope: [db_snapshots, object_storage, logs]`
    },
    log_policy: {
      title:'Immutable Log (excerpt)',
      code:`log_stream:\n  format: jsonl\n  hash_chain: enabled\n  export: [csv, pdf]\n  retention_days: 3650`
    },
    prompt_block: {
      title:'Prompt Blocklist (example)',
      code:`blocked_phrases:\n  - "ignore all previous"\n  - "developer mode"\n  - "leak secrets"`
    },
    rag_guard: {
      title:'RAG Guardrails (policy)',
      code:`rag:\n  retrieval_top_k: 6\n  min_doc_score: 0.7\n  allowlist_sources: [knowledge_base, policy_wiki]`
    },
    rate_limit: {
      title:'Rate Limiting (policy)',
      code:`limits:\n  per_user_per_minute: 60\n  per_ip_per_minute: 120\n  burst: 15`
    },
    quorum_policy: {
      title:'Quorum Updates (policy)',
      code:`updates:\n  critical_components: [core, router, rbac]\n  quorum: 2\n  signers: [security@veltrax, platform@veltrax]`
    },
    pii_redact: {
      title:'PII Redaction (rules)',
      code:`redaction:\n  patterns: [email, phone, ssn]\n  mode: replace\n  replacement: "[REDACTED]"`
    },
    audit_review: {
      title:'Audit Trail Review (SOP excerpt)',
      code:`schedule:\n  frequency: monthly\n  reviewers: [security, compliance]\n  sample_size: 30\n  report: pdf`
    }
  }
};

// ========= DOM helpers ========= //
const $ = (id)=>document.getElementById(id);
const threatList=$('threatList'), controlList=$('controlList'), evidenceCard=$('evidenceCard');
const profileSel=$('profile');

function badgeFor(controlKey){
  const prof=MODEL.profiles[profileSel.value];
  const {required=[], recommended=[], optional=[]} = prof.badges;
  if(required.includes(mapName(controlKey))) return '<span class="pill req">Required</span>';
  if(recommended.includes(mapName(controlKey))) return '<span class="pill rec">Recommended</span>';
  return '<span class="pill opt">Optional</span>';
}
function mapName(key){
  return ({ rbac:'AuthN/Z', encrypt_rest:'Encryption', dmz_verify:'Change mgmt', logging:'Logging', prompt_block:'RAG guardrails', rag_guard:'RAG guardrails', rate_limit:'Change mgmt', signed_release:'Change mgmt', quorum:'Quorum updates', pii_redact:'PII redaction', data_min:'Data minimization', audit_trail:'Audit logging' })[key] || key;
}

let currentThreat=null, currentControl=null;

function renderThreats(){
  threatList.innerHTML='';
  MODEL.threats.forEach(t=>{
    const div=document.createElement('button');
    div.className='item';
    div.setAttribute('role','option');
    div.setAttribute('aria-label',t.name);
    div.textContent=t.name;
    div.addEventListener('click',()=> selectThreat(t.id));
    div.addEventListener('keydown',(e)=>{ if(e.key==='Enter') selectThreat(t.id); });
    threatList.appendChild(div);
  });
}

function selectThreat(id){
  currentThreat=id; currentControl=null; evidenceCard.innerHTML='<div class="muted">Select a control to view evidence.</div>';
  [...threatList.children].forEach(ch=> ch.setAttribute('aria-current', ch.textContent===MODEL.threats.find(t=>t.id===id).name ));
  renderControls();
}

function renderControls(){
  controlList.innerHTML='';
  const t=MODEL.threats.find(x=>x.id===currentThreat); if(!t) return;
  t.map.forEach(key=>{
    const c=MODEL.controls[key];
    const div=document.createElement('button');
    div.className='item';
    div.innerHTML = `<div><strong>${c.name}</strong> ${badgeFor(key)}</div>`;
    div.addEventListener('click',()=> selectControl(key));
    div.addEventListener('keydown',(e)=>{ if(e.key==='Enter') selectControl(key); });
    controlList.appendChild(div);
  });
}

function selectControl(key){
  currentControl=key;
  const ekey=MODEL.controls[key].evidence;
  const e=MODEL.evidence[ekey];
  evidenceCard.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;gap:10px"><div><strong>${e.title}</strong></div><button class="btn" id="copyBtn">Copy</button></div><pre><code>${escapeHtml(e.code)}</code></pre>`;
  document.getElementById('copyBtn').addEventListener('click',()=>{
    navigator.clipboard.writeText(e.code).then(()=>{ document.getElementById('copyBtn').textContent='Copied!'; setTimeout(()=>document.getElementById('copyBtn').textContent='Copy',900); });
  });
}

function escapeHtml(s){ return s.replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

// Profile toggle influences badges
profileSel.addEventListener('change',()=>{ if(currentThreat) renderControls(); });

// Theme toggle
$('theme').addEventListener('click',()=> document.documentElement.classList.toggle('light'));

// Init
renderThreats(); selectThreat('data_exfil');
</script>
</body>
</html>
